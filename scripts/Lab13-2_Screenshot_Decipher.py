__VERSION__ = '1.0'
DESC="""Practical_Malware_Analysis Lab13-2 - Dynamic screenshot decipher (instrumentation)"""

import immlib
import os

def main(args):
	folder = args[0]
	prefix_path = folder
	for file in os.listdir(folder):
		cfile = open(prefix_path + "\\" + file, 'rb')
		pfile = open(prefix_path + "\\" + file + "_decoded.bmp",'w')
		imm = immlib.Debugger()
		
		buffer = cfile.read()
		sz = len(buffer)
		
		membuf = imm.remoteVirtualAlloc(sz)
		imm.writeMemory(membuf, buffer)
		
		imm.setReg("EIP", 0x00401851)
		imm.setBreakpoint(0x0040187B)
		imm.run()
		
		regs = imm.getRegs()
		edx_save = imm.getRegs()['EDX']
		imm.setReg("EDX", sz)
		imm.setBreakpoint(0x0040187F)
		imm.run()
		
		imm.setReg("EDX", edx_save)
		eax_save = imm.getRegs()['EAX']
		imm.setReg("EAX", membuf)
		imm.setBreakpoint(0x00401880)
		imm.run()
		
		imm.setReg("EAX", eax_save)
		imm.setBreakpoint(0x00401885)
		imm.run()
		
		output = imm.readMemory(membuf, sz)
		pfile.write(output)
		
	result = "output saved to: " + str(folder)
	
	return result